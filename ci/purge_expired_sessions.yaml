platform: linux
image_resource:
  type: docker-image
  source:
    repository: alpine
params:
  PROJECT_ID:
  DATETIME:
run:
  path: sh
  args:
    - -exc
    - |
      gcloud dataflow jobs run purgesession \
      --region europe-west2 \
      --gcs-location gs://dataflow-templates/latest/Datastore_to_Datastore_Delete \
      --parameters \
      datastoreReadGqlQuery="SELECT * FROM \`eq-session\` WHERE expires_at < `date +%s`",\
      datastoreReadProjectId="${PROJECT_ID}",\
      datastoreDeleteProjectId="${PROJECT_ID}"
