platform: linux
image_resource:
  type: docker-image
  source:
    repository: theorf/google-cloud-sdk-helm
inputs:
  - name: eq-questionnaire-runner
params:
  GOOGLE_APPLICATION_CREDENTIALS: /root/gcloud-service-key.json
  SERVICE_ACCOUNT_JSON: ((gcp.service_account_json))
  GCP_ENVIRONMENT_NAME:
  EQ_KEYS_FILE:
  EQ_SECRETS_FILE:
  DOCKER_REGISTRY:
  GOOGLE_TAG_MANAGER_ID:
  GOOGLE_TAG_MANAGER_AUTH:
  GOOGLE_TAG_MANAGER_PREVIEW:
  COOKIE_SETTINGS_URL:
  REQUESTED_CPU_PER_POD:
  ROLLING_UPDATE_MAX_UNAVAILABLE:
  ROLLING_UPDATE_MAX_SURGE:
  MIN_REPLICAS:
  MAX_REPLICAS:
  TARGET_CPU_UTILIZATION_PERCENTAGE:
  REGION:
run:
  path: bash
  args:
    - -exc
    - |
      apt-get install -y procps

      cat >$GOOGLE_APPLICATION_CREDENTIALS <<EOL
      $SERVICE_ACCOUNT_JSON
      EOL

      gcloud auth activate-service-account --key-file ${GOOGLE_APPLICATION_CREDENTIALS}

      cd eq-questionnaire-runner

      helm init --client-only
      helm plugin install https://github.com/rimusz/helm-tiller

      PROJECT_ID=($(gcloud projects list --filter=name="${GCP_ENVIRONMENT_NAME}" --format="value(PROJECT_ID)"))

      [[ "${#PROJECT_ID[@]}" = 1 ]] || exit 1

      SUBMISSION_BUCKET_NAME=${PROJECT_ID}-survey-runner-submission
      IMAGE_TAG=$(cat .git/HEAD | xargs echo -n)

      gcloud container clusters get-credentials survey-runner --region ${REGION} --project ${PROJECT_ID}
      ./k8s/deploy_credentials.sh
      SUBMISSION_BUCKET_NAME="$SUBMISSION_BUCKET_NAME" IMAGE_TAG="$IMAGE_TAG" ./k8s/deploy_app.sh

